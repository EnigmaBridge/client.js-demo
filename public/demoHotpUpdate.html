<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enigma Bridge REST demo</title>
    <link rel="shortcut icon" type="image/png" href="favicon.png" />
    <style>
        body,p,td,input {font-family: Arial, Helvetica, sans-serif; font-size: 10pt;}
        h1 {font-size: 14pt; }
        h2 {font-size: 12pt; }
        input[disabled]{
            background-color: #F8F8F8;
        }
        .qr {
            padding-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        .qrWrap {
            /*overflow: auto;*/
        }
    </style>
    <link href='css/googleapi-FamilyBitter.css' rel='stylesheet' type='text/css'/>
    <link rel="stylesheet" type="text/css" href="forms.css"/>
    <script src="jquery-1.12.1.min.js"></script>
    <script src="sprintf.js"></script>
    <script src="sjcl.js"></script>
    <script src="jquery.qrcode.min.js"></script>
    <script src="he.js"></script>
    <script src="enigma.js"></script>
    <script src="demo.js"></script>
    <script>
        "use strict";
        var defaults = {
            site: 'site2.enigmabridge.com',
            site1: 'site1.enigmabridge.com',
            site2: 'site2.enigmabridge.com'
        };

        // Update context flag.
        var updateCtxFlag=false;
    </script>
</head>
<body>

<!-- form design: http://www.sanwebe.com/2014/08/css-html-forms-designs -->
<!-- info: http://jacob.jkrall.net/totp/ -->
<div class="form-style-10">
    <h1>EnigmaBridge HOTP API test<span>HOTP context update demo</span></h1>
    <form>

        <div class="section"><span>1</span>AuthContext update</div>
        <div class="inner-wrap">
            <label>
                <input type="radio" name="update" value="attempts" id="updateAttempts" />
                Failed attempts
                <span>Reset global failed attempts counter</span>
            </label>

            <label>
                <input type="radio" name="update" value="hotp" id="updateHotp" checked/>
                HOTP
                <span>Reset HOTP token</span>
            </label>

            <label>
                <input type="radio" name="update" value="password" id="updatePassword" />
                Password
                <span>Reset password</span>
            </label>

            <label>Password
                <input type="text" name="authPassword" id="authPassword" placeholder="new user password"/>
                <span>New password to set</span>
            </label>
        </div>

        <div class="section"><span>2</span>Context definition</div>
        <div class="inner-wrap">
            <label>User ID
                <input type="text" name="userId" id="userId" placeholder="hex-coded user ID"/>
                <span>User ID generated by the service</span>
            </label>

            <label>User context
                <input type="text" name="userCtx" id="userCtx" placeholder="binary blob" class="crc-src"/>
                <input type="text" name="userCtxCrc" id="userCtxCrc" placeholder="CRC" readonly="readonly" class="crc-dst"/>
                <span>User context generated by the service, used for further authentication requests</span>
            </label>
        </div>

        <div class="section" id="divConfigHead">
            <span>3</span>
            Configuration
            <div class="collapser">[-]</div>
        </div>
        <div class="inner-wrap" id="divConfig">
            <label>API Key
                <input type="text" name="apiKey" id="apiKey" value="TEST_API"/>
                <span>Your EB API key</span>
            </label>

            <label>User object ID
                <input type="text" name="userObjectID" id="userObjectID" placeholder="UserObjectID" value="55aa"/>
                <span>User object used for context update.</span>
            </label>

            <label>ProcessData method
                <input type="text" name="processDataMethod" id="processDataMethod" value="AUTH_UPDATEUSERCTX" placeholder="ProcessData method"/>
                <span>
                </span>
            </label>

            <label>Endpoint
                <input type="text" name="endpoint" id="endpoint" placeholder="endpoint.address.com"/>
                <span>Hostname of the EB API
                    <a onclick="$('#endpoint').val(defaults.site1);">site1</a>,
                    <a onclick="$('#endpoint').val(defaults.site2);">site2</a></span>
            </label>

            <label>Method
                <select id="requestMethod" name="requestMethod">
                    <option value="POST">POST</option>
                    <option value="GET">GET</option>
                </select>
            </label>

            <label>Scheme
                <select id="requestScheme" name="requestScheme">
                    <option value="https">https</option>
                    <option value="http">http</option>
                </select>
            </label>

            <label>AES encryption key
                <input type="text" name="aesKey" id="aesKey" value="1234567890123456789012345678901234567890123456789012345678901234"/>
                <span>Hexcoded encryption API key
                </span>
            </label>

            <label>MAC key
                <input type="text" name="macKey" id="macKey" value="2224262820223456789012345678901234567890123456789012345678901234"/>
                <span>Hexcoded hmac API key
                </span>
            </label>

            <label>HOTP digits
                <input type="text" name="hotpDigits" id="hotpDigits" value="8"/>
                <span>Number of digits in HOTP code
                </span>
            </label>
        </div>

        <div class="section"><span>4</span>Response</div>
        <div class="inner-wrap">
            <label>Status code
                <input type="text" name="hotpStatus" id="hotpStatus" placeholder="Update status code" readonly="readonly"/>
                <span>Update result, 9000 means success</span>
            </label>

            <label>Updated user context
                <input type="text" name="newUserCtx" id="newUserCtx" placeholder="binary blob" readonly="readonly" class="crc-src"/>
                <input type="text" name="newUserCtxCrc" id="newUserCtxCrc" placeholder="CRC" readonly="readonly" class="crc-dst"/>
                <span>User context updated by the service, used for further authentication requests.
                <a onclick="updateCtx()">Update context in the request</a>
                </span>
            </label>

            <label>HOTP secret
                <input type="text" name="hotpSecret" id="hotpSecret" placeholder="HOTP secret key" readonly="readonly" class="crc-src"/>
                <input type="text" name="hotpSecretCrc" id="hotpSecretCrc" placeholder="CRC" readonly="readonly" class="crc-dst"/>
                <span>HOTP secret key for the user, used for HOTP token initialization</span>
            </label>

            <label>QR link
                <input type="text" name="qrLink" id="qrLink" placeholder="QR code content" readonly="readonly"/>
                <span>QR code content used to initialize authenticator</span>
            </label>

            <div id="redirBlock">
                <a href="#" id="redirHref" target="_blank">Try authentication here</a>
            </div>

            <div class="qrWrap">
                <div id="qrcode" class="qr"></div>
            </div>
        </div>
        <div class="button-section">
            <input type="button" id="btnUpdate" value="Update"/>
        </div>
    </form>
</div>

<label for="reqRest">Request: </label>
<div id="reqRest" class="logbox"></div>
<br/>

<label for="status">Log: </label>
<div id="status" class="logbox"></div>

<script>
    "use strict";
    $('#endpoint').val(defaults.site);
    $('#divConfigHead').click(toggleCategory);
    $('#divConfigHead').click();
    $('#hotpSecret').keyup(function(){updateCrcs();});
    $('#userCtx').keyup(function(){updateCrcs();});

    // Password editable only if password method is selected
    var apass = $("#authPassword");
    var upass = $("#updatePassword");
    var uhotp = $("#updateHotp");
    var uatmp = $("#updateAttempts");
    upass.click(passwordEnabledCheck);
    uhotp.click(passwordEnabledCheck);
    uatmp.click(passwordEnabledCheck);
    uhotp.click();

    function passwordEnabledCheck(){
        apass.prop('disabled', !upass.is(':checked'));
        $('#hotpSecret').prop('disabled', !uhotp.is(':checked'));
        $('#qrLink').prop('disabled', !uhotp.is(':checked'));
        $('#redirBlock').prop('disabled', !uhotp.is(':checked'));
        $('#qrWrap').prop('disabled', !uhotp.is(':checked'));
    }

    function log(msg){
        console.log(msg);
        append_message(msg);
    }

    function getSettings(){
        var apiKey = $('#apiKey').val();
        var keyId = parseInt($('#userObjectID').val(), 16);
        var endpoint = $('#endpoint').val();
        var method = $('#requestMethod').val();
        var scheme = $('#requestScheme').val();

        return {
            remoteEndpoint: endpoint,
            remotePort: 11180,
            requestMethod: method,
            requestScheme: scheme,
            requestTimeout: 7000,
            debuggingLog: true,
            apiKey: apiKey,
            apiKeyLow4Bytes: keyId,
            userObjectId : keyId
        };
    }

    function updateCtx(){
        var newCtx = $('#newUserCtx').val();
        if (!newCtx || newCtx.length==0){
            console.log("Empty CTX");
            return;
        }

        $('#userCtx').val(newCtx);
        updateCrcs();
    }

    function updateCrcs(){
        updateCrc($('#hotpSecretCrc'), $('#hotpSecret').val());
        updateCrc($('#userCtxCrc'), $('#userCtx').val());
        updateCrc($('#newUserCtxCrc'), $('#newUserCtx').val());
    }

    function updateCrc(dstElem, srcData){
        dstElem.val(srcData !== undefined && srcData.length > 0 ? eb.misc.genChecksumValue(srcData, 4) : '');
    }

    function resetFields(){
        $('#qrcode').html("");
        $('#qrcode2').html("");
        $('#qrLink').val("");
        $('#redirBlock').hide('slow');
    }

    function connectionError(data){
        resetFields();
        $('#hotpSecret').val("");
        $('#newUserCtx').val("");

        statusFieldSet($('#hotpStatus'), "Connection error", false);
    }

    function finished(response){
        var digits = $('#hotpDigits').val();
        var statusElem = $('#hotpStatus');
        var responseStatus = response.hotpStatus;
        if ((responseStatus === undefined || responseStatus == 0x0) && response.statusCode != eb.comm.status.SW_STAT_OK){
            responseStatus = response.statusCode;
        }

        var status = sprintf("0x%04X", responseStatus);
        if (responseStatus == eb.comm.status.SW_STAT_OK){
            status += ' - Context updated successfully';
        } else if (responseStatus == eb.comm.status.SW_AUTHMETHOD_NOT_ALLOWED){
            status += ' - Failed, authentication method not allowed';
        } else {
            status += ' - Failed, unknown error';
        }

        statusFieldSet(statusElem, status, response.hotpStatus == eb.comm.status.SW_STAT_OK);
        if (response.hotpKey){
            $('#hotpSecret').val(sjcl.codec.hex.fromBits(response.hotpKey));

            // QR code for picky iPhones.
            var qrLink2 = eb.comm.hotp.hotpGetQrLink(response.hotpKey, {
                label: sjcl.codec.hex.fromBits(response.hotpUserId),
                web: "demo.enigmabridge.com",
                issuer: "EnigmaBridge",
                ctr:0,
                digits: digits,
                stripPadding: true
            });
            $('#qrLink').val(qrLink2);
            log("QR link2: " + qrLink2);

            $('#qrcode').html("");
            $('#qrcode').qrcode(qrLink2);
        }

        if (response.hotpUserCtx){
            $('#newUserCtx').val(sjcl.codec.hex.fromBits(response.hotpUserCtx));
        }

        // Auth link.
        $('#redirBlock').show('slow');
        $('#redirHref').attr("href", sprintf("demoHotpAuth.html?key=%s&userId=%s&userCtx=%s&digits=%d",
                $('#hotpSecret').val(),
                sjcl.codec.hex.fromBits(response.hotpUserId),
                sjcl.codec.hex.fromBits(response.hotpUserCtx),
                digits
        ));

        if (updateCtxFlag){
            updateCtx();
        }

        updateCrcs();
    }

    function requestSimple(){
        var h = sjcl.codec.hex;
        var aesKey = $('#aesKey').val();
        var macKey = $('#macKey').val();
        var pDataMethod = $('#processDataMethod').val();
        var body = $("body");

        // Flush old messages.
        display_message("");
        set_request("");

        var logger = function(msg) {
            append_message(msg);
        };

        var endpointConfig = getSettings();
        var userConfig = {
            aesKey: aesKey,
            macKey: macKey,
            callRequestType: pDataMethod
        };

        var method = undefined;
        if (upass.is(':checked')){
            method = eb.comm.hotp.USERAUTH_FLAG_PASSWD;
        } else if (uhotp.is(':checked')){
            method = eb.comm.hotp.USERAUTH_FLAG_HOTP;
        } else if (uatmp.is(':checked')){
            method = eb.comm.hotp.USERAUTH_FLAG_GLOBALTRIES;
        }

        var userId = $('#userId').val();
        var userCtx = $('#userCtx').val();
        var password = $('#authPassword').val();
        var reqConfig = {hotp:{
            'userId': userId,
            'userCtx': userCtx,
            'method': method
        }};

        if (method == eb.comm.hotp.USERAUTH_FLAG_PASSWD) {
            reqConfig.hotp.passwd = sjcl.hash.sha256.hash(password);
        }

        var request = new eb.comm.hotp.authContextUpdateRequest(reqConfig);
        request.configure(userConfig);
        request.configure(endpointConfig);

        // Logging settings.
        request.logger = logger;

        // Callbacks settings.
        request.done(function(response, requestObj, data) {
            log("DONE! " + response.toString());
            finished(response);

        }).fail(function(failType, data){
            log("fail! type=" + failType);
            if (failType == eb.comm.status.PDATA_FAIL_RESPONSE_FAILED){
                log("Fail msg: " + data.response.toString());
                finished(data.response);

            } else if (failType == eb.comm.status.PDATA_FAIL_CONNECTION){
                log("Connection error");
                connectionError(data);
            }

        }).always(function(request, data){
            log("it is over...");
            body.removeClass("loading");
        });

        // Build the request so we can display request in the form.
        request.build();
        set_request(sprintf("%s<br/>\n%s<br/>\n%s<br/>\n",
                request.getApiUrl(),
                JSON.stringify(request.getApiRequestData()),
                JSON.stringify(request.getSocketRequest())));

        // Do the call.
        statusFieldSet($('#hotpStatus'), '...');
        body.addClass("loading");
        resetFields();

        request.doRequest();
    }

    $(function(){
        // Start random number collectors.
        sjcl.random.startCollectors();
        $('#redirBlock').hide();

        // Parse query parameters - init hotp.
        var userId = getURLParameter('userId');
        var userCtx = getURLParameter('userCtx');
        var digits = getURLParameter('digits');
        var hotpSecret = getURLParameter('key');
        if (userId !== undefined){
            $('#userId').val(userId);
        }
        if (userCtx !== undefined){
            $('#userCtx').val(userCtx);
        }
        if (digits !== undefined){
            $('#hotpDigits').val(digits);
        }
        if (hotpSecret !== undefined){
            $('#hotpSecret').val(hotpSecret);
        }
        updateCrcs();

        // Button click handling.
        $('#btnUpdate').click(function(){
            updateCtxFlag=false;
            requestSimple();
        });
    });

</script>
<div class="modal"><div class="modal-wrap"></div></div>
</body>
</html>